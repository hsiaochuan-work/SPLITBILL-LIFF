<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«é€Ÿåˆ†å¸³</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background-color: #f5f5f5; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: #333; }
        label { display: block; margin-top: 15px; font-weight: bold; color: #555; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 16px; }
        
        /* æˆå“¡å‹¾é¸å€å¡Šæ¨£å¼ */
        #members-container { margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .checkbox-item { display: flex; align-items: center; background: #fafafa; padding: 10px; border-radius: 5px; border: 1px solid #eee; }
        .checkbox-item input { margin-right: 10px; width: 20px; height: 20px; }
        
        button { width: 100%; padding: 15px; background-color: #06c755; color: white; border: none; border-radius: 5px; font-size: 18px; font-weight: bold; margin-top: 25px; cursor: pointer; }
        button:disabled { background-color: #ccc; }
        .loading { text-align: center; color: #888; font-size: 14px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ’¸ æ–°å¢è¨˜å¸³</h2>
    
    <label>é …ç›®</label>
    <input type="text" id="item" placeholder="ä¾‹å¦‚ï¼šæ™šé¤ã€è¨ˆç¨‹è»Š">

    <label>é‡‘é¡</label>
    <input type="number" id="price" placeholder="è¼¸å…¥é‡‘é¡">

    <label>èª°å…ˆä»˜éŒ¢ï¼Ÿ</label>
    <select id="payer">
        <option value="æˆ‘">æˆ‘ (ç•¶å‰ç”¨æˆ¶)</option>
        </select>

    <label>èª°è¦åˆ†æ”¤ï¼Ÿ <span style="font-size:12px; font-weight:normal; color:#888;">(æ²’å‹¾ = å…¨å“¡åˆ†æ”¤)</span></label>
    <div id="loading-text" class="loading">æ­£åœ¨è¼‰å…¥æˆå“¡åå–®...</div>
    <div id="members-container"></div>

    <button id="submit-btn" onclick="submitBill()">é€å‡ºè¨˜å¸³</button>
</div>

<script>
    // ğŸ”´ è¨­å®šå€ï¼šè«‹æ›æˆä½ çš„è³‡è¨Š
    const LIFF_ID = "2008909973-yvMKbhMT"; 
    const API_GET_MEMBERS = "https://hsiaochuan.zeabur.app/webhook/get-members"; // å‰›å‰›å»ºç«‹çš„ GET API
    const API_POST_BILL = "https://hsiaochuan.zeabur.app/webhook/split-bill";   // ä¸Šä¸€è¼ªå»ºç«‹çš„ POST API

    // 1. åˆå§‹åŒ– LIFF
    document.addEventListener("DOMContentLoaded", async () => {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) {
                liff.login();
            }
            // å–å¾—ä½¿ç”¨è€…è³‡æ–™ (ç‚ºäº†çŸ¥é“"æˆ‘"æ˜¯èª°ï¼Œé¸å¡«)
            const profile = await liff.getProfile();
            // å¯ä»¥åœ¨é€™è£¡æŠŠ payer ä¸‹æ‹‰é¸å–®é è¨­å€¼æ”¹æˆ profile.displayName

            // è¼‰å…¥æˆå“¡åå–®
            loadMembers();
        } catch (err) {
            alert("LIFF åˆå§‹åŒ–å¤±æ•—: " + err);
        }
    });

    // 2. å¾ n8n è®€å–æˆå“¡åå–®
    async function loadMembers() {
        try {
            const response = await fetch(API_GET_MEMBERS);
            const data = await response.json(); 
            // å‡è¨­ n8n å›å‚³æ ¼å¼æ˜¯ { "members": ["å°æ˜", "å°è¯", "å°ç¾"] }
            
            const container = document.getElementById('members-container');
            document.getElementById('loading-text').style.display = 'none';

            data.members.forEach(member => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.innerHTML = `
                    <input type="checkbox" name="split_member" value="${member}">
                    <span>${member}</span>
                `;
                container.appendChild(div);
            });
        } catch (err) {
            document.getElementById('loading-text').innerText = "ç„¡æ³•è¼‰å…¥åå–®";
            console.error(err);
        }
    }

    // 3. é€å‡ºè³‡æ–™
    async function submitBill() {
        const item = document.getElementById('item').value;
        const price = document.getElementById('price').value;
        const payer = document.getElementById('payer').value;
        
        // æŠ“å–æ‰€æœ‰è¢«å‹¾é¸çš„äºº
        const checkboxes = document.querySelectorAll('input[name="split_member"]:checked');
        const selectedMembers = Array.from(checkboxes).map(cb => cb.value);

        if(!item || !price) {
            alert("è«‹è¼¸å…¥é …ç›®å’Œé‡‘é¡ï¼");
            return;
        }

        const btn = document.getElementById('submit-btn');
        btn.innerText = "è™•ç†ä¸­...";
        btn.disabled = true;

        try {
            // å–å¾—ç•¶å‰ä½¿ç”¨è€…åå­— (è‹¥ payer é¸ 'æˆ‘')
            let finalPayer = payer;
            if(payer === 'æˆ‘') {
                const profile = await liff.getProfile();
                finalPayer = profile.displayName; // ç”¨ LINE æš±ç¨±ï¼Œæˆ–æ˜¯ä½ æƒ³è¦å¯«æ­»ä¹Ÿå¯ä»¥
            }

            const payload = {
                item: item,
                price: parseInt(price),
                payer: finalPayer,
                selectedMembers: selectedMembers // å‚³é€å‹¾é¸çš„åå–® (ç©ºé™£åˆ—ä»£è¡¨æ²’å‹¾)
            };

            // ç™¼é€çµ¦ n8n
            await fetch(API_POST_BILL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            alert("âœ… è¨˜å¸³æˆåŠŸï¼");
            liff.closeWindow(); // é—œé–‰è¦–çª—

        } catch (err) {
            alert("ç™¼ç”ŸéŒ¯èª¤ï¼š" + err);
            btn.innerText = "é€å‡ºè¨˜å¸³";
            btn.disabled = false;
        }
    }
</script>

</body>
</html>
